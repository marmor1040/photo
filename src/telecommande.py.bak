'''
Created on 28 juin 2020

@author: marc
'''
import time,os,sys
import os.path as osp
import bluetooth
import sys

addr="30:4B:07:22:E3:B8"
def setup_bt_client(addr, port):
    client_sock = bluetooth.BluetoothSocket(bluetooth.RFCOMM)
    client_sock.setblocking(True)
    timeout = 10
    while timeout > 0:
        try:
            client_sock.connect((addr, port))
            timeout = -1
        except bluetooth.btcommon.BluetoothError:
            time.sleep(1)
            timeout -= 1
            print("Waiting for connection...")
            continue

    if timeout == 0:
        print("Could not connect to server! PLZ try again and hope for better luck")
        return client_sock
    else:
        print("Successfully connected to ", addr)
        return client_sock 
#setup_bt_client(addr,1)
def find_bt_address_by_target_name(name):
    # sometimes bluetooth.discover_devices() failed to find all the devices
    MAX_COUNT = 3
    count = 0
    while True:
        nearby_devices = bluetooth.discover_devices()

        for btaddr in nearby_devices:
            #print btaddr
            if name == bluetooth.lookup_name( btaddr ):
                print (name)
                return btaddr

        count += 1
        if count > MAX_COUNT:
            return None
        print("Try one more time to find target device..")    

#addr = find_bt_address_by_target_name("moto g(6) play")
addr="30:4B:07:22:E3:B8"
try:
    server_sock = bluetooth.BluetoothSocket( bluetooth.RFCOMM )
    server_sock.setblocking(False)

    port = 1
    server_sock.bind(("",port))
    server_sock.listen(1)
    
    client_sock,address = server_sock.accept()
    #print "Accepted connection from ",address
    
    data = client_sock.recv(1024)
    #print "received [%s]" % data
    
    client_sock.close()
    server_sock.close()
except:
    import traceback,time
    traceback.print_exc()
    time.sleep(10)
sys.exit()
